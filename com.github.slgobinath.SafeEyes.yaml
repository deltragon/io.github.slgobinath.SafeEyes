id: com.github.slgobinath.SafeEyes
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Platform
runtime-version: "22.08"
command: safeeyes

finish-args:
  - --share=network
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  - --system-talk-name=org.freedesktop.DBus # for tray icon
  - --talk-name=org.freedesktop.Notifications # for 'notification before breaks' plugin
  - --talk-name=com.canonical.indicator.application
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=org.ayatana.indicator.application
  - --talk-name=org.gnome.Mutter.IdleMonitor
  - --talk-name=org.kde.StatusNotifierWatcher
  # - --env=GI_TYPELIB_PATH=/app/lib/girepository-1.0:/app/plugins/lib/girepository-1.0

# Cleanup after the python modules
cleanup:
  - /cache
  - /man
  - /share/aclocal
  - /share/devhelp
  - /include
  - /lib/pkgconfig
  - /share/gtk-doc
  - /share/man
  - /lib/*.a
  - /lib/*.la

modules:
  # app indicator
  - shared-modules/libappindicator/libappindicator-gtk3-introspection-12.10.json
  - shared-modules/libappindicator/libappindicator-gtk3-12.10.json

  # auto generated pip dependencies for safeeyes
  # install pycairo first or build fails
  # install order is: pycairo -> setuptools-scm -> safeeyes
  # `python3 flatpak-pip-generator.py  --runtime='org.freedesktop.Sdk//22.08' PKGNAME`
  - pypi-dependencies.json

  # dbus - for tray
  - name: dbus-python
    buildsystem: autotools
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-1.3.2.tar.gz
        sha256: ad67819308618b5069537be237f8e68ca1c7fcc95ee4a121fe6845b1418248f8

  # required for 'wayland do not disturb' plugin
  - name: wlrctl
    buildsystem: meson
    sources:
      - type: archive
        url: https://git.sr.ht/~brocellous/wlrctl/archive/v0.2.1.tar.gz
        sha256: de8848de0a81749fe7ee7316bead0261bd978e26c2f899d02897609972a6e98c

  # required for 'audible alert' plugin
  - name: alsa-utils
    buildsystem: simple
    build-commands:
      - ./configure --prefix=/app --disable-alsaconf --with-udev-rules-dir=/app/null --with-systemdsystemunitdir=/app/null
      - make install
    sources:
      - type: archive
        url: https://www.alsa-project.org/files/pub/utils/alsa-utils-1.2.8.tar.bz2
        sha256: e140fa604c351f36bd72167c8860c69d81b964ae6ab53992d6434dde38e9333c

  # notification support
  - name: libnotify
    buildsystem: meson
    config-opts:
      - -Dman=false
      - -Dtests=false
      - -Dgtk_doc=false
      - -Ddocbook_docs=disabled
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libnotify/0.8/libnotify-0.8.2.tar.xz
        sha256: c5f4ed3d1f86e5b118c76415aacb861873ed3e6f0c6b3181b828cf584fc5c616
        x-checker-data:
          project-id: 13149
          type: anitya
          url-template: https://download.gnome.org/sources/libnotify/$major.$minor/libnotify-$version.tar.xz

  - name: safeeyes
    buildsystem: simple
    build-commands:
      - install -Dm644 com.github.slgobinath.SafeEyes.png /app/share/icons/hicolor/128x128/apps/com.github.slgobinath.SafeEyes.png
      - install -Dm644 com.github.slgobinath.SafeEyes.desktop /app/share/applications/com.github.slgobinath.SafeEyes.desktop
      - install -Dm644 com.github.slgobinath.SafeEyes.metainfo.xml /app/share/metainfo/com.github.slgobinath.SafeEyes.metainfo.xml

    sources:
      - type: file
        path: com.github.slgobinath.SafeEyes.png

      - type: file
        path: com.github.slgobinath.SafeEyes.desktop

      - type: file
        path: com.github.slgobinath.SafeEyes.metainfo.xml

  # ---------------------------------------------------------------------

  # $ python3 -c "from gi.repository import Notify"
  # ImportError: cannot import name Notify, introspection typelib not found

  # $ python3 -c "import gi; print(gi.__version__)"
  # 3.44.1

  # ```
  # import gi
  # gi.require_version('Notify', '0.7')
  # from gi.repository import Notify
  # notification = Notify.Notification.new('Safe Eyes', message, icon='safeeyes_enabled')
  # notification.show()
  # ```
  # > raise ValueError('Namespace %s not available' % namespace)
  #   ValueError: Namespace Notify not available
